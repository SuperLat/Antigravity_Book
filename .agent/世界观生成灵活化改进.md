# 世界观生成灵活化改进

## 改进概述

将世界观生成功能从**固定字段填充**模式升级为**灵活内容选择**模式，用户可以自由选择要包含的素材，提供更大的创作灵活性。

## 主要变更

### 1. 服务层 (`services/geminiService.ts`)

#### 新增函数: `generateWorldviewWithContext`
- **功能**: 接受自由组合的上下文文本，而非固定字段
- **参数**: 
  - `contextText`: 用户手动组合的上下文文本
  - `customTemplate`: 可选的自定义模板
- **优势**: 
  - 不再受限于预定义字段结构
  - 用户可以包含任意内容组合
  - 支持自定义素材输入

### 2. 组件层 (`components/IdeaLab.tsx`)

#### 新增状态
```typescript
const [showWorldviewContextSelector, setShowWorldviewContextSelector] = useState(false);
const [selectedWorldviewFields, setSelectedWorldviewFields] = useState<string[]>(['spark', 'core', 'synopsis']);
const [customWorldviewContext, setCustomWorldviewContext] = useState('');
```

#### 重构函数: `handleGenerateDetailedBackground`
- **字段映射**: 将 IdeaProject 的字段映射为可选择项
- **动态构建**: 根据用户选择动态组合上下文
- **灵活验证**: 只要有选中字段或自定义文本即可生成

#### 新增 UI 组件
1. **素材选择按钮**: 显示已选素材数量，切换选择器面板
2. **内容选择器面板**: 
   - 字段复选框（6个可选字段）
   - 自定义文本输入区
   - 快捷操作（全选/清空）
   - 实时统计显示

## 用户体验改进

### 之前的流程
1. 系统自动从固定字段提取内容
2. 用户无法控制包含哪些信息
3. 缺少灵活性

### 现在的流程
1. 点击"选择素材"按钮
2. 勾选想要包含的字段（核心灵感、故事内核、概要等）
3. 可选：输入额外的自定义素材或特殊要求
4. 点击"生成详细背景"
5. AI 基于选中的内容生成世界观

## 可选字段列表

| 字段 | 标签 | 说明 |
|------|------|------|
| `spark` | 核心灵感 | 最初的创意火花 |
| `core` | 故事内核 | 故事的哲学内涵 |
| `synopsis` | 故事概要 | 故事的背景和发展方向 |
| `genre` | 故事类型 | 如玄幻、科幻等 |
| `background` | 故事背景 | 如东方玄幻、赛博朋克等 |
| `length` | 故事篇幅 | 长篇/短篇 |

## 技术亮点

1. **向后兼容**: 保留了原有的 `generateDetailedWorldview` 函数
2. **默认选择**: 默认选中核心字段（spark, core, synopsis）
3. **智能禁用**: 未填写的字段自动禁用，防止误选
4. **实时反馈**: 按钮显示已选素材数量
5. **优雅降级**: 即使没有固定字段，也可以只用自定义文本生成

## 示例使用场景

### 场景 1: 标准流程
- 选择: 核心灵感 + 故事内核 + 故事概要
- 结果: 基于完整故事设定生成世界观

### 场景 2: 极简流程
- 选择: 仅核心灵感
- 自定义: "参考《三体》的黑暗森林法则"
- 结果: 基于灵感和参考资料生成世界观

### 场景 3: 完全自定义
- 选择: 无
- 自定义: 粘贴一段网文大纲或设定文档
- 结果: 基于自定义内容生成世界观

## 代码质量

- ✅ TypeScript 类型安全
- ✅ 响应式 UI 设计
- ✅ 清晰的状态管理
- ✅ 用户友好的交互
- ✅ 中文注释完整
