# 灵感实验室全流程素材选择功能实现方案

## 目标
为灵感实验室的所有生成阶段添加灵活的素材选择功能，让用户可以自由选择前面已生成的内容作为上下文。

## 各阶段可选素材

### 1. 世界观生成 ✅ (已完成)
**可选字段**:
- 核心灵感 (spark)
- 故事内核 (core)
- 故事概要 (synopsis)
- 故事类型 (genre)
- 故事背景 (background)
- 故事篇幅 (length)
- 自定义素材

### 2. 人物小传生成 (待实现)
**可选字段**:
- 核心灵感 (spark)
- 故事内核 (core)
- 故事概要 (synopsis)
- 世界观 (worldview) ⭐ 新增
- 自定义素材

### 3. 大纲生成 (待实现)
**可选字段**:
- 核心灵感 (spark)
- 故事内核 (core)
- 故事概要 (synopsis)
- 世界观 (worldview)
- 人物小传 (characters) ⭐ 新增
- 自定义素材

### 4. 分卷生成 (待实现)
**可选字段**:
- 大纲内容 (outline)
- 自定义素材

### 5. 细纲生成 (待实现)
**可选字段**:
- 核心灵感 (spark)
- 故事内核 (core)
- 故事概要 (synopsis)
- 世界观 (worldview)
- 人物小传 (characters)
- 大纲 (outline)
- 分卷 (volumes)
- 自定义素材

## 实现步骤

### 阶段1: 状态管理 ✅
已添加各阶段的选择器状态:
```typescript
// 人物小传
const [showCharacterContextSelector, setShowCharacterContextSelector] = useState(false);
const [selectedCharacterFields, setSelectedCharacterFields] = useState<string[]>(['spark', 'core', 'synopsis', 'worldview']);
const [customCharacterContext, setCustomCharacterContext] = useState('');

// 大纲
const [showOutlineContextSelector, setShowOutlineContextSelector] = useState(false);
const [selectedOutlineFields, setSelectedOutlineFields] = useState<string[]>(['spark', 'core', 'synopsis', 'worldview', 'characters']);
const [customOutlineContext, setCustomOutlineContext] = useState('');
```

### 阶段2: 服务层函数改造
需要为以下函数添加灵活上下文支持:

1. **人物生成**: `generateCharactersFromIdea` 
   - 当前已支持context对象
   - 需要添加 `generateCharactersWithContext` 版本

2. **大纲生成**: `generateCompleteOutline`
   - 当前已支持context对象
   - 需要添加 `generateOutlineWithContext` 版本

3. **分卷生成**: `generateVolumesFromOutline`
   - 当前只接受outline字符串
   - 需要改造为接受灵活上下文

4. **细纲生成**: `generateBeatsFromVolumeContent`
   - 当前已有较完善的context支持
   - 可能需要微调

### 阶段3: UI组件实现
为每个阶段添加类似世界观的素材选择面板:

```typescript
// 人物小传阶段
{showCharacterContextSelector && (
  <div className="w-80 flex-shrink-0 animate-in slide-in-from-left duration-200">
    {/* 素材选择面板 */}
  </div>
)}
```

### 阶段4: 生成函数改造
修改各阶段的生成处理函数，使用动态构建的上下文:

```typescript
const handleGenerateCharacters = async () => {
  // 1. 根据selectedCharacterFields构建上下文
  const contextParts = [];
  selectedCharacterFields.forEach(field => {
    // 添加字段内容
  });
  
  // 2. 调用灵活版本的生成函数
  const result = await generateCharactersWithContext(config, contextText, customTemplate);
};
```

## 技术要点

1. **字段映射统一化**: 创建通用的字段映射函数
2. **上下文构建复用**: 提取公共的上下文构建逻辑
3. **UI组件复用**: 创建可复用的素材选择面板组件
4. **向后兼容**: 保留原有函数，新增灵活版本

## 优先级

1. ⭐ 人物小传生成 (高优先级)
2. ⭐ 大纲生成 (高优先级)
3. 分卷生成 (中优先级)
4. 细纲生成 (低优先级，已有较好的上下文支持)

## 下一步行动

建议先完成**人物小传**的素材选择功能，作为模板，然后复制到其他阶段。
