# 简化实现方案：通用上下文构建器

## 核心思路

不修改服务层函数，而是在组件层创建一个**通用的上下文构建辅助函数**，在调用现有API前动态构建context对象。

## 实现代码

```typescript
// 在 IdeaLab.tsx 中添加通用辅助函数
const buildContextFromSelection = (
  selectedFields: string[],
  customText: string,
  activeIdea: IdeaProject
): Record<string, any> => {
  const context: Record<string, any> = {};
  
  selectedFields.forEach(field => {
    switch(field) {
      case 'spark':
        if (activeIdea.spark) context.spark = activeIdea.spark;
        break;
      case 'core':
        if (activeIdea.storyCore) context.core = activeIdea.storyCore;
        break;
      case 'synopsis':
        if (activeIdea.storySynopsis) context.synopsis = activeIdea.storySynopsis;
        break;
      case 'worldview':
        if (activeIdea.worldview) context.worldview = activeIdea.worldview;
        break;
      case 'characters':
        if (activeIdea.characters) {
          // 格式化人物信息
          context.charactersText = activeIdea.characters.map(c => 
            `${c.name}(${c.role}): ${c.description}`
          ).join('\n');
        }
        break;
      // ... 其他字段
    }
  });
  
  if (customText) {
    context.customContext = customText;
  }
  
  return context;
};
```

## 使用示例

```typescript
const handleGenerateCharacters = async () => {
  // 构建上下文
  const context = buildContextFromSelection(
    selectedCharacterFields,
    customCharacterContext,
    activeIdea
  );
  
  // 调用现有API，传入动态构建的context
  const result = await generateCharactersFromIdea(tempConfig, {
    spark: context.spark || activeIdea.spark, // 保底使用原字段
    core: context.core,
    synopsis: context.synopsis,
    worldview: context.worldview,
    requirements: charGenReqs
  }, customTemplate);
};
```

## 优势

1. ✅ 不需要修改服务层代码
2. ✅ 复用现有API
3. ✅ 实现简单快速
4. ✅ 易于维护

## 下一步

1. 添加通用构建函数
2. 修改人物生成处理函数
3. 添加UI素材选择面板
4. 复制到其他阶段
